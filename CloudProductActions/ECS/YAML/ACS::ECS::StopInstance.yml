FormatVersion: OOS-2019-06-01
Description:
  name-en: ACS::ECS::StopInstance
  name-zh-cn: 停止ECS实例
  en: Stops an ECS instance
  zh-cn: 停止一台ECS实例
Parameters:
  regionId:
    Description:
      en: The ID of region
      zh-cn: 地域ID
    Type: String
    Default: '{{ ACS::RegionId }}'
  instanceId:
    Description:
      en: The ID of ECS instance
      zh-cn: ECS实例ID
    Type: String
  stoppedMode:
    Description:
      en: Indicates whether the ECS instance is still charged after it is stopped
      zh-cn: 停止按量付费ECS实例后，是否继续计费
    Type: String
    Default: ''
  hibernate:
    Description:
      en: Whether to hibernate the instance
      zh-cn: 实例是否休眠
    Type: Boolean
    Default: false
Tasks:
- Name: getInstanceStatus
  Description:
    en: Queries the ECS instances status
    zh-cn: 获取ECS实例的状态
  Action: ACS::ExecuteApi
  Properties:
    Service: ECS
    API: DescribeInstances
    Parameters:
      RegionId: '{{ regionId }}'
      InstanceIds:
        - '{{ instanceId }}'
  Outputs:
    status:
      Type: String
      ValueSelector: Instances.Instance[].Status
- Name: whetherInstanceIsStopped
  Action: 'ACS::Choice'
  Description:
    en: Choose next task by instance Stopped status
    zh-cn: 根据实例的已停止状态选择下一个任务
  Properties:
    DefaultTask: whetherInstanceIsStopping
    Choices:
      - When:
          'Fn::Equals':
            - Stopped
            - '{{ getInstanceStatus.status }}'
        NextTask: 'ACS::END'
- Name: whetherInstanceIsStopping
  Action: 'ACS::Choice'
  Description:
    en: Choose next task by instance Stopping status
    zh-cn: 根据实例的停止中状态选择下一个任务
  Properties:
    DefaultTask: stopInstance
    Choices:
      - When:
          'Fn::Equals':
            - Stopping
            - '{{ getInstanceStatus.status }}'
        NextTask: untilInstanceReady
- Name: stopInstance
  Action: ACS::ExecuteAPI
  Description:
    en: Stops ECS instance
    zh-cn: 停止ECS实例
  Properties:
    Service: ECS
    API: StopInstance
    Parameters:
      RegionId: '{{ regionId }}'
      InstanceId: '{{ instanceId }}'
      StoppedMode: '{{ stoppedMode }}'
      Hibernate: '{{ hibernate }}'
- Name: untilInstanceReady
  Action: ACS::WaitFor
  Description:
    en: Waits for the ECS instance to enter Stopped status
    zh-cn: 等待ECS实例至已停止状态
  Properties:
    Service: ECS
    API: DescribeInstances
    Parameters:
      RegionId: '{{ regionId }}'
      InstanceIds:
      - '{{ instanceId }}'
    DesiredValues:
    - Stopped
    PropertySelector: Instances.Instance[].Status
